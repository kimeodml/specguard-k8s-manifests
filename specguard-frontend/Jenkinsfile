pipeline {
    agent any

    parameters {
        string(name: 'DOCKER_IMAGE_VERSION', defaultValue: '', description: 'Docker Image Version')
        string(name: 'DID_BUILD_APP', defaultValue: '', description: 'Did Build APP')
    }

    stages {
        stage('Checkout Main Branches') {
            steps {
                sh 'git checkout main'
                echo "DOCKER_IMAGE_VERSION: ${params.DOCKER_IMAGE_VERSION}"
            }
        }

        stage('update Vue deploy.yaml') {
            steps {
                // Jenkins íŒŒì´í”„ë¼ì¸ì—ì„œ ì‘ì—… ë””ë ‰í„°ë¦¬ë¥¼ ë³€ê²½í•  ë•Œ ì‚¬ìš©í•œë‹¤.
                dir('specguard-frontend') {
                    sh 'pwd'
                    sh 'ls -al'
                    echo "Received Docker Image Version : ${params.DOCKER_IMAGE_VERSION}"
                    sh "sed -i 's|kimeodml/specguard-frontend:.*|kimeodml/specguard-frontend:${params.DOCKER_IMAGE_VERSION}|g' deploy.yaml"
                    sh 'cat deploy.yaml'
                }
            }
        }

        stage('Commit & Push') {
            when {
                expression {
                    return params.DID_BUILD_APP == "true"
                }
            }
            
            steps {
                sh 'git config user.name "jenkins"'
                sh 'git config user.email "jenkins@beyond.com"'

                // ë³€ê²½ëœ íŒŒì¼ ìˆëŠ”ì§€ í™•ì¸
                script {
                    def changes = sh(script: "git status --porcelain", returnStdout: true).trim()
                    if (changes) {
                        echo "ğŸ”¹ ë³€ê²½ ì‚¬í•­ ê°ì§€ë¨ â†’ ì»¤ë°‹ ë° í‘¸ì‹œ ì‹¤í–‰"

                        sh 'git add .'
                        sh "git commit -m '[Auto] update image version ${params.DOCKER_IMAGE_VERSION}'"
                        
                        sshagent(['specguard-k8s-manifests']) {
                            sh 'git push origin main'
                        }
                    } else {
                        echo "âšª ë³€ê²½ ì‚¬í•­ ì—†ìŒ â†’ ì»¤ë°‹/í‘¸ì‹œ ìƒëµ"
                    }
                }
            }
        }
    }
}